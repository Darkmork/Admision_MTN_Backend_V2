apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: admissions
  labels:
    app.kubernetes.io/name: mtn-admission-system
    app.kubernetes.io/component: security
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: platform-security-team
spec:
  # Enforce STRICT mTLS for all workloads in the admissions namespace
  # This ensures all pod-to-pod communication is encrypted and authenticated
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: istio-proxy-mtls
  namespace: istio-system
  labels:
    app.kubernetes.io/name: istio-system
    app.kubernetes.io/component: security
spec:
  # Ensure istio-proxy components also use STRICT mTLS
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: monitoring-mtls
  namespace: monitoring
  labels:
    app.kubernetes.io/name: monitoring-system
    app.kubernetes.io/component: security
spec:
  # Allow monitoring traffic from Prometheus/Grafana
  # Use PERMISSIVE to allow scraping metrics endpoints
  mtls:
    mode: PERMISSIVE
  portLevelMtls:
    # Enforce STRICT mTLS on application ports
    8080:
      mode: STRICT
    8443:
      mode: STRICT
    # Allow metrics scraping on monitoring ports
    9090:
      mode: PERMISSIVE
    9464:
      mode: PERMISSIVE
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: database-mtls
  namespace: postgres
  labels:
    app.kubernetes.io/name: postgres-system
    app.kubernetes.io/component: security
spec:
  # Database connections require mTLS from application services
  mtls:
    mode: STRICT
  portLevelMtls:
    5432:
      mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: rabbitmq-mtls
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq-system
    app.kubernetes.io/component: security
spec:
  # RabbitMQ messaging requires mTLS
  mtls:
    mode: STRICT
  portLevelMtls:
    5672:  # AMQP port
      mode: STRICT
    15672: # Management UI - allow monitoring
      mode: PERMISSIVE