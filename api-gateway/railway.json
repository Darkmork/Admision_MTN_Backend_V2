{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile"
  },
  "deploy": {
    "startCommand": "nginx -g 'daemon off;'",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 5
  }
}
# API Gateway NGINX para Railway

Este directorio contiene la configuraciÃ³n del API Gateway NGINX para el sistema de admisiÃ³n MTN desplegado en Railway.

## ğŸ“ Estructura

```
api-gateway/
â”œâ”€â”€ conf/
â”‚   â”œâ”€â”€ local-gateway.conf      # ConfiguraciÃ³n para desarrollo local
â”‚   â”œâ”€â”€ railway-gateway.conf    # ConfiguraciÃ³n para Railway â­
â”‚   â””â”€â”€ nginx-proxy-headers.conf
â”œâ”€â”€ Dockerfile                   # Para desplegar NGINX en Railway
â”œâ”€â”€ .env.railway                # Variables de entorno ejemplo
â”œâ”€â”€ RAILWAY_SETUP.md            # DocumentaciÃ³n detallada
â””â”€â”€ README.md                   # Este archivo
```

## ğŸš€ Inicio RÃ¡pido

### OpciÃ³n 1: ConfiguraciÃ³n AutomÃ¡tica (Recomendado)

```bash
# Ejecutar el script de configuraciÃ³n
./scripts/configure-railway-nginx.sh
```

Este script te pedirÃ¡ las URLs de tus servicios y actualizarÃ¡ automÃ¡ticamente la configuraciÃ³n.

### OpciÃ³n 2: ConfiguraciÃ³n Manual

1. **Obtener las URLs de Railway:**
   - Ve a https://railway.app/dashboard
   - Para cada servicio, copia su URL pÃºblica

2. **Editar la configuraciÃ³n:**
   ```bash
   nano api-gateway/conf/railway-gateway.conf
   ```

3. **Reemplazar las URLs de ejemplo:**
   ```nginx
   # Buscar y reemplazar:
   admision-user-service.railway.app       â†’ TU-URL-REAL.railway.app
   admision-application-service.railway.app â†’ TU-URL-REAL.railway.app
   # ... etc
   ```

## ğŸ³ Desplegar en Railway

### MÃ©todo 1: Como servicio independiente

1. **Crear nuevo servicio en Railway:**
   ```bash
   railway link
   railway up
   ```

2. **Configurar el servicio:**
   - En Railway dashboard, ve a tu nuevo servicio
   - Settings â†’ Deploy â†’ Root Directory: `api-gateway`
   - Railway detectarÃ¡ automÃ¡ticamente el Dockerfile

3. **Configurar variables de entorno:**
   - Copia las variables de `.env.railway`
   - Actualiza con tus URLs reales

### MÃ©todo 2: Usando Docker localmente

```bash
# Construir imagen
docker build -t mtn-gateway ./api-gateway

# Ejecutar
docker run -p 8080:8080 mtn-gateway
```

## ğŸ”§ Servicios Configurados

El gateway enruta a los siguientes microservicios:

| Ruta API | Servicio | Puerto Railway |
|----------|----------|----------------|
| `/api/auth` | user-service | 443 (HTTPS) |
| `/api/users` | user-service | 443 (HTTPS) |
| `/api/applications` | application-service | 443 (HTTPS) |
| `/api/evaluations` | evaluation-service | 443 (HTTPS) |
| `/api/interviews` | evaluation-service | 443 (HTTPS) |
| `/api/notifications` | notification-service | 443 (HTTPS) |
| `/api/email` | notification-service | 443 (HTTPS) |
| `/api/dashboard` | dashboard-service | 443 (HTTPS) |
| `/api/analytics` | dashboard-service | 443 (HTTPS) |
| `/api/guardians` | guardian-service | 443 (HTTPS) |

## âœ… VerificaciÃ³n

### Probar el gateway localmente:

```bash
# Health check
curl http://localhost:8080/health

# Estado del gateway
curl http://localhost:8080/gateway/status

# MÃ©tricas
curl http://localhost:8080/gateway/metrics
```

### Probar el gateway en Railway:

```bash
# Reemplaza con tu URL de Railway
export GATEWAY_URL="https://tu-gateway.railway.app"

# Health check
curl $GATEWAY_URL/health

# Probar autenticaciÃ³n
curl -X POST $GATEWAY_URL/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```

## ğŸ”’ Seguridad Configurada

- âœ… **Rate Limiting**: Previene abuso de API
- âœ… **CORS**: Solo permite orÃ­genes especÃ­ficos
- âœ… **HTTPS**: Conexiones SSL/TLS a servicios
- âœ… **Headers de Seguridad**: XSS, Clickjacking, etc.
- âœ… **Request Size Limits**: ProtecciÃ³n contra payloads grandes

## ğŸ“Š CaracterÃ­sticas

- **Keepalive Connections**: Conexiones persistentes para mejor rendimiento
- **Gzip Compression**: CompresiÃ³n automÃ¡tica de respuestas
- **Circuit Breaker**: Timeouts y failover configurados
- **Health Checks**: Monitoreo de disponibilidad
- **Custom Error Pages**: Respuestas JSON para errores

## ğŸ› Troubleshooting

### Error 502 Bad Gateway
```bash
# Verificar que los servicios estÃ©n corriendo
railway status

# Ver logs del gateway
railway logs
```

### CORS Errors
- Verifica que tu frontend estÃ© en la lista de orÃ­genes permitidos
- Edita el mapa `$cors_origin` en `railway-gateway.conf`

### Timeout Errors
- Aumenta los timeouts en la configuraciÃ³n:
  ```nginx
  proxy_read_timeout 60s;
  proxy_connect_timeout 30s;
  ```

## ğŸ“š DocumentaciÃ³n Adicional

- [RAILWAY_SETUP.md](./RAILWAY_SETUP.md) - GuÃ­a completa de configuraciÃ³n
- [DocumentaciÃ³n NGINX](https://nginx.org/en/docs/)
- [Railway Docs](https://docs.railway.app/)

## ğŸ†˜ Soporte

Si necesitas ayuda:
1. Revisa los logs: `railway logs`
2. Verifica la configuraciÃ³n: `nginx -t`
3. Consulta RAILWAY_SETUP.md para problemas comunes

