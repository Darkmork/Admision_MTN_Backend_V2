version: "prometheus/v1"
service: "notification-service"
labels:
  team: "backend"
  environment: "production"
  component: "notifications"
  
slos:
  # Latency SLO - 99% of requests should complete in <2s
  - name: "requests-latency"
    objective: 99
    description: "99% of notification service HTTP requests should complete in less than 2 seconds"
    sli:
      events:
        error_query: sum(rate(http_server_requests_seconds_count{app="notification-service", le!="2"}[5m]))
        total_query: sum(rate(http_server_requests_seconds_count{app="notification-service"}[5m]))
    alerting:
      name: NotificationServiceLatency
      labels:
        category: latency
        service: notification-service
      annotations:
        summary: "Notification Service latency SLO violation"
        runbook: "https://runbooks.mtn.cl/slo/notification-service-latency"
      page_alert:
        labels:
          severity: page
          team: backend
        annotations:
          summary: "Notification Service latency SLO burn rate is critical"
          description: "Email and notification processing is slow"
          impact: "Delayed notifications to families about application status and important updates"
          action: "Check SMTP service performance, verify email template processing, review queue processing speed"
      ticket_alert:
        labels:
          severity: ticket
          team: backend
        annotations:
          summary: "Notification Service latency trending towards SLO violation"

  # Availability SLO - 95% of requests should be successful
  - name: "requests-availability"
    objective: 95
    description: "95% of notification service HTTP requests should be successful (status code <500)"
    sli:
      events:
        error_query: sum(rate(http_server_requests_seconds_count{app="notification-service",status=~"5.."}[5m]))
        total_query: sum(rate(http_server_requests_seconds_count{app="notification-service"}[5m]))
    alerting:
      name: NotificationServiceAvailability
      labels:
        category: availability
        service: notification-service
      annotations:
        summary: "Notification Service availability SLO violation"
        runbook: "https://runbooks.mtn.cl/slo/notification-service-availability"
      page_alert:
        labels:
          severity: page
          team: backend
        annotations:
          summary: "Notification Service availability SLO burn rate is critical"
          description: "Notification service experiencing high error rates"
          impact: "Families not receiving critical notifications about application status, interview scheduling"
          action: "IMMEDIATE: Check SMTP connectivity, verify email service credentials, review notification queue processing"
      ticket_alert:
        labels:
          severity: ticket
          team: backend
        annotations:
          summary: "Notification Service availability requires investigation"

  # Email Delivery Success Rate SLO - 97% of emails should be delivered successfully
  - name: "email-delivery-success"
    objective: 97
    description: "97% of email notifications should be delivered successfully"
    sli:
      events:
        error_query: sum(rate(email_notifications_sent_total{app="notification-service",status!="delivered"}[5m]))
        total_query: sum(rate(email_notifications_sent_total{app="notification-service"}[5m]))
    alerting:
      name: EmailDeliverySuccess
      labels:
        category: business_logic
        service: notification-service
      annotations:
        summary: "Email delivery success rate SLO violation"
        runbook: "https://runbooks.mtn.cl/slo/email-delivery-success"
      page_alert:
        labels:
          severity: page
          team: backend
        annotations:
          summary: "Email delivery failure rate is critical"
          description: "High number of email delivery failures"
          impact: "Families not receiving important notifications about their applications"
          action: "Check SMTP service health, verify email addresses validation, review bounce handling"
      ticket_alert:
        labels:
          severity: ticket
          team: backend
        annotations:
          summary: "Email delivery success rate trending down"

  # Notification Processing Speed SLO - 95% of notifications should be processed within 5 minutes
  - name: "notification-processing-speed"
    objective: 95
    description: "95% of notifications should be processed within 5 minutes of creation"
    sli:
      events:
        error_query: sum(rate(notification_processing_duration_seconds_count{app="notification-service", le!="300"}[5m]))
        total_query: sum(rate(notification_processing_duration_seconds_count{app="notification-service"}[5m]))
    alerting:
      name: NotificationProcessingSpeed
      labels:
        category: latency
        service: notification-service
      annotations:
        summary: "Notification processing speed SLO violation"
        runbook: "https://runbooks.mtn.cl/slo/notification-processing-speed"
      page_alert:
        labels:
          severity: page
          team: backend
        annotations:
          summary: "Notification processing is too slow"
          description: "Notifications taking longer than 5 minutes to process"
          impact: "Delayed communication with families about critical application updates"
          action: "Check notification queue backlog, verify worker pool size, review database query performance"
      ticket_alert:
        labels:
          severity: ticket
          team: backend
        annotations:
          summary: "Notification processing speed degrading"

  # Template Rendering Success Rate SLO - 99.5% of templates should render successfully
  - name: "template-rendering-success"
    objective: 99.5
    description: "99.5% of email templates should render successfully"
    sli:
      events:
        error_query: sum(rate(email_template_rendering_total{app="notification-service",status!="success"}[5m]))
        total_query: sum(rate(email_template_rendering_total{app="notification-service"}[5m]))
    alerting:
      name: TemplateRenderingSuccess
      labels:
        category: business_logic
        service: notification-service
      annotations:
        summary: "Email template rendering success rate SLO violation"
        runbook: "https://runbooks.mtn.cl/slo/template-rendering-success"
      page_alert:
        labels:
          severity: page
          team: backend
        annotations:
          summary: "Email template rendering failure rate is critical"
          description: "High number of email template rendering failures"
          impact: "Emails may be sent with malformed content or not sent at all"
          action: "Check template syntax, verify data binding logic, review template cache health"
      ticket_alert:
        labels:
          severity: ticket
          team: backend
        annotations:
          summary: "Email template rendering success rate trending down"